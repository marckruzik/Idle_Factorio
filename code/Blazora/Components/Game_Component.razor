@using BlazorApp.Shared.Models
@using NS_Game_Engine
@implements IDisposable
@using Blazora.Pages
@using NS_Blazora_Basic

@code{
    
    [Parameter] public Position position { get; set; }
    [Parameter] public Game_Component parent { get; set; }


    Manager_Listener manager_listener = new Manager_Listener ();
    
    public bool need_refresh = true;

    public string id = "GC_Unknown";

    public List<Game_Component> list_child = new List<Game_Component> ();
}





@code {


    public string from_position_get_style ()
    {
        return $"position: absolute;" +
                $"{(position != null ? $"left: {position.x}px" : "")};" +
                $"{(position != null ? $"top: {position.y}px" : "")};" +
                $"{(position != null ? $"width: {position.width}px" : "")};" +
                $"{(position != null ? $"height: {position.height}px" : "")};";
    }


    protected override void OnInitialized ()
    {
        base.OnInitialized ();
        listener_setup ();
        Game_Page.list_component.Add (this);
        if (this.parent != null)
        {
            this.parent.list_child.Add (this);
        }
    }



    public virtual void graphical_update ()
    {
        listener_update ();

        if (this.need_refresh == false)
        {
            return;
        }

        StateHasChanged ();
        this.need_refresh = false;
    }


    public void self_child_display ()
    {
        Console.WriteLine (this.id);
        foreach (Game_Component gc in ienumerable_get_child ())
        {
            Console.WriteLine (gc.id);
        }
    }

    public IEnumerable<Game_Component> ienumerable_get_child ()
    {
        foreach (Game_Component gc in this.list_child)
        {
            yield return gc;
            foreach (Game_Component g in gc.ienumerable_get_child ())
            {
                yield return g;
            }
        }

    }


    public virtual void listener_setup ()
    {

    }

    public Dictionary<Type, List<IObservableProperty>> dico_typ_plus_list_observable =
        new Dictionary<Type, List<IObservableProperty>> ();

    public void listener_add<T> (string info, ObservableProperty<T> observable)
    {
        if (observable == null)
        {
            return;
        }
        observable.changed += refresh;

        Console.WriteLine ($"Listener for Game_Component {this.id} with [{observable.id}]{info} (total listener: {observable.get_listener_count ()})");

        if (dico_typ_plus_list_observable.ContainsKey (typeof(T)) == false)
        {
            dico_typ_plus_list_observable.Add (typeof (T), new List<IObservableProperty> ());
        }
        dico_typ_plus_list_observable[typeof(T)].Add (observable);
    }


    public void refresh<T> (T val)
    {
        this.need_refresh = true;
    }


    public void listener_add<T> (Func<T> func)
    {
        this.manager_listener.add (func);
    }

    public void listener_update ()
    {
        bool need_update = this.manager_listener.need_update ();
        if (need_update == true)
        {
            this.need_refresh = true;
        }
    }

    public void listener_remove ()
    {
        if (dico_typ_plus_list_observable.Keys.Count > 3)
        {
            throw new Exception ("Game_Component: incorrect number of observable types");
        }

        if (dico_typ_plus_list_observable.ContainsKey (typeof (int)) == true)
        {
            foreach (ObservableProperty<int> obs in dico_typ_plus_list_observable[typeof (int)])
            {
                obs.changed -= refresh<int>;
            }
            dico_typ_plus_list_observable[typeof (int)].Clear ();
        }

        if (dico_typ_plus_list_observable.ContainsKey (typeof (string)) == true)
        {
            foreach (ObservableProperty<string> obs in dico_typ_plus_list_observable[typeof (string)])
            {
                obs.changed -= refresh<string>;
            }
            dico_typ_plus_list_observable[typeof (string)].Clear ();
        }

        if (dico_typ_plus_list_observable.ContainsKey (typeof (bool)) == true)
        {
            foreach (ObservableProperty<bool> obs in dico_typ_plus_list_observable[typeof (bool)])
            {
                obs.changed -= refresh<bool>;
            }
            dico_typ_plus_list_observable[typeof (bool)].Clear ();
        }

        this.manager_listener.clear ();
    }


    public void listener_replace ()
    {
        listener_remove ();
        listener_setup ();
    }


    public virtual void Dispose ()
    {
        Game_Page.list_component.Remove (this);
        listener_remove ();
    }
}
